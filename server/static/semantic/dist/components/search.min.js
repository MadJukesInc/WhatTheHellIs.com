/*!
 * # Semantic UI x.x - Search
 * http://github.com/semantic-org/semantic-ui/
 *
 *
 * Copyright 2015 Contributors
 * Released under the MIT license
 * http://opensource.org/licenses/MIT
 *
 */
!function(e,t,s,r){"use strict";e.fn.search=function(n){var i,a=e(this),c=a.selector||"",o=(new Date).getTime(),u=[],l=arguments[0],d="string"==typeof l,f=[].slice.call(arguments,1);return e(this).each(function(){var p,g=e.isPlainObject(n)?e.extend(!0,{},e.fn.search.settings,n):e.extend({},e.fn.search.settings),v=g.className,h=g.metadata,m=g.regExp,b=g.selector,y=g.error,C=g.namespace,R="."+C,w=C+"-module",x=e(this),j=x.find(b.prompt),q=x.find(b.searchButton),k=x.find(b.results),A=(x.find(b.result),x.find(b.category),this),E=x.data(w);p={initialize:function(){p.verbose("Initializing module"),p.determine.searchFields(),p.bind.events(),p.set.type(),p.create.results(),p.instantiate()},instantiate:function(){p.verbose("Storing instance of module",p),E=p,x.data(w,p)},destroy:function(){p.verbose("Destroying instance"),x.off(R).removeData(w)},bind:{events:function(){p.verbose("Binding events to search"),g.automatic&&(x.on(p.get.inputEvent()+R,b.prompt,p.event.input),j.attr("autocomplete","off")),x.on("focus"+R,b.prompt,p.event.focus).on("blur"+R,b.prompt,p.event.blur).on("keydown"+R,b.prompt,p.handleKeyboard).on("click"+R,b.searchButton,p.query).on("mousedown"+R,b.results,p.event.result.mousedown).on("mouseup"+R,b.results,p.event.result.mouseup).on("click"+R,b.result,p.event.result.click)}},determine:{searchFields:function(){n&&n.searchFields!==r&&(g.searchFields=n.searchFields)}},event:{input:function(){clearTimeout(p.timer),p.timer=setTimeout(p.query,g.searchDelay)},focus:function(){p.set.focus(),p.has.minimumCharacters()&&(p.query(),p.showResults())},blur:function(e){var t=s.activeElement===this;t||p.resultsClicked||(p.cancel.query(),p.remove.focus(),p.timer=setTimeout(p.hideResults,g.hideDelay))},result:{mousedown:function(){p.resultsClicked=!0},mouseup:function(){p.resultsClicked=!1},click:function(s){p.debug("Search result selected");var r=e(this),n=r.find(b.title).eq(0),i=r.find("a[href]").eq(0),a=i.attr("href")||!1,c=i.attr("target")||!1,o=(n.html(),n.length>0&&n.text()),u=p.get.results(),l=r.data(h.result)||p.get.result(o,u);return e.isFunction(g.onSelect)&&g.onSelect.call(A,l,u)===!1?void p.debug("Custom onSelect callback cancelled default select action"):(p.hideResults(),o&&p.set.value(o),void(a&&(p.verbose("Opening search link found in result",i),"_blank"==c||s.ctrlKey?t.open(a):t.location.href=a)))}}},handleKeyboard:function(e){var t,s=x.find(b.result),r=x.find(b.category),n=s.index(s.filter("."+v.active)),i=s.length,a=e.which,c={backspace:8,enter:13,escape:27,upArrow:38,downArrow:40};if(a==c.escape&&(p.verbose("Escape key pressed, blurring search field"),j.trigger("blur")),p.is.visible())if(a==c.enter){if(p.verbose("Enter key pressed, selecting active result"),s.filter("."+v.active).length>0)return p.event.result.click.call(s.filter("."+v.active),e),e.preventDefault(),!1}else a==c.upArrow?(p.verbose("Up key pressed, changing active result"),t=n-1<0?n:n-1,r.removeClass(v.active),s.removeClass(v.active).eq(t).addClass(v.active).closest(r).addClass(v.active),e.preventDefault()):a==c.downArrow&&(p.verbose("Down key pressed, changing active result"),t=n+1>=i?n:n+1,r.removeClass(v.active),s.removeClass(v.active).eq(t).addClass(v.active).closest(r).addClass(v.active),e.preventDefault());else a==c.enter&&(p.verbose("Enter key pressed, executing query"),p.query(),p.set.buttonPressed(),j.one("keyup",p.remove.buttonFocus))},setup:{api:function(){var e={debug:g.debug,on:!1,cache:"local",action:"search",onError:p.error};p.verbose("First request, initializing API"),x.api(e)}},can:{useAPI:function(){return e.fn.api!==r},transition:function(){return g.transition&&e.fn.transition!==r&&x.transition("is supported")}},is:{empty:function(){return""===k.html()},visible:function(){return k.filter(":visible").length>0},focused:function(){return j.filter(":focus").length>0}},get:{inputEvent:function(){var e=j[0],t=e!==r&&e.oninput!==r?"input":e!==r&&e.onpropertychange!==r?"propertychange":"keyup";return t},value:function(){return j.val()},results:function(){var e=x.data(h.results);return e},result:function(t,s){var n=["title","id"],i=!1;return t=t!==r?t:p.get.value(),s=s!==r?s:p.get.results(),"category"===g.type?(p.debug("Finding result that matches",t),e.each(s,function(s,r){if(e.isArray(r.results)&&(i=p.search.object(t,r.results,n)[0]))return!1})):(p.debug("Finding result in results object",t),i=p.search.object(t,s,n)[0]),i||!1}},set:{focus:function(){x.addClass(v.focus)},loading:function(){x.addClass(v.loading)},value:function(e){p.verbose("Setting search input value",e),j.val(e)},type:function(e){e=e||g.type,"category"==g.type&&x.addClass(g.type)},buttonPressed:function(){q.addClass(v.pressed)}},remove:{loading:function(){x.removeClass(v.loading)},focus:function(){x.removeClass(v.focus)},buttonPressed:function(){q.removeClass(v.pressed)}},query:function(){var t=p.get.value(),s=p.read.cache(t);p.has.minimumCharacters()?s?(p.debug("Reading result from cache",t),p.save.results(s.results),p.addResults(s.html),p.inject.id(s.results)):(p.debug("Querying for",t),e.isPlainObject(g.source)||e.isArray(g.source)?p.search.local(t):p.can.useAPI()?p.search.remote(t):p.error(y.source),g.onSearchQuery.call(A,t)):p.hideResults()},search:{local:function(e){var t,s=p.search.object(e,g.content);p.set.loading(),p.save.results(s),p.debug("Returned local search results",s),t=p.generateResults({results:s}),p.remove.loading(),p.addResults(t),p.inject.id(s),p.write.cache(e,{html:t,results:s})},remote:function(t){var s={onSuccess:function(e){p.parse.response.call(A,e,t)},onFailure:function(){p.displayMessage(y.serverError)},urlData:{query:t}};x.api("get request")||p.setup.api(),e.extend(!0,s,g.apiSettings),p.debug("Executing search",s),p.cancel.query(),x.api("setting",s).api("query")},object:function(t,s,n){var i=[],a=[],c=t.toString().replace(m.escape,"\\$&"),o=new RegExp(m.beginsWith+c,"i"),u=function(t,s){var r=e.inArray(s,i)==-1,n=e.inArray(s,a)==-1;r&&n&&t.push(s)};return s=s||g.source,n=n!==r?n:g.searchFields,e.isArray(n)||(n=[n]),s===r||s===!1?(p.error(y.source),[]):(e.each(n,function(r,n){e.each(s,function(e,s){var r="string"==typeof s[n];r&&(s[n].search(o)!==-1?u(i,s):g.searchFullText&&p.fuzzySearch(t,s[n])&&u(a,s))})}),e.merge(i,a))}},fuzzySearch:function(e,t){var s=t.length,r=e.length;if("string"!=typeof e)return!1;if(e=e.toLowerCase(),t=t.toLowerCase(),r>s)return!1;if(r===s)return e===t;e:for(var n=0,i=0;n<r;n++){for(var a=e.charCodeAt(n);i<s;)if(t.charCodeAt(i++)===a)continue e;return!1}return!0},parse:{response:function(e,t){var s=p.generateResults(e);p.verbose("Parsing server response",e),e!==r&&t!==r&&e.results!==r&&(p.addResults(s),p.inject.id(e.results),p.write.cache(t,{html:s,results:e.results}),p.save.results(e.results))}},cancel:{query:function(){p.can.useAPI()&&x.api("abort")}},has:{minimumCharacters:function(){var e=p.get.value(),t=e.length;return t>=g.minCharacters}},clear:{cache:function(e){var t=x.data(h.cache);e?e&&t&&t[e]&&(p.debug("Removing value from cache",e),delete t[e],x.data(h.cache,t)):(p.debug("Clearing cache",e),x.removeData(h.cache))}},read:{cache:function(e){var t=x.data(h.cache);return!!g.cache&&(p.verbose("Checking cache for generated html for query",e),"object"==typeof t&&t[e]!==r&&t[e])}},create:{id:function(e,t){var s,n,i=e+1;return t!==r?(s=String.fromCharCode(97+t),n=s+i,p.verbose("Creating category result id",n)):(n=i,p.verbose("Creating result id",n)),n},results:function(){0===k.length&&(k=e("<div />").addClass(v.results).appendTo(x))}},inject:{result:function(e,t,s){p.verbose("Injecting result into results");var n=s!==r?k.children().eq(s).children(b.result).eq(t):k.children(b.result).eq(t);p.verbose("Injecting results metadata",n),n.data(h.result,e)},id:function(t){p.debug("Injecting unique ids into results");var s=0,n=0;return"category"===g.type?e.each(t,function(t,i){n=0,e.each(i.results,function(e,t){var a=i.results[e];a.id===r&&(a.id=p.create.id(n,s)),p.inject.result(a,n,s),n++}),s++}):e.each(t,function(e,s){var i=t[e];i.id===r&&(i.id=p.create.id(n)),p.inject.result(i,n),n++}),t}},save:{results:function(e){p.verbose("Saving current search results to metadata",e),x.data(h.results,e)}},write:{cache:function(e,t){var s=x.data(h.cache)!==r?x.data(h.cache):{};g.cache&&(p.verbose("Writing generated html to cache",e,t),s[e]=t,x.data(h.cache,s))}},addResults:function(t){return e.isFunction(g.onResultsAdd)&&g.onResultsAdd.call(k,t)===!1?(p.debug("onResultsAdd callback cancelled default action"),!1):(k.html(t),void p.showResults())},showResults:function(){p.is.visible()||!p.is.focused()||p.is.empty()||(p.can.transition()?(p.debug("Showing results with css animations"),k.transition({animation:g.transition+" in",debug:g.debug,verbose:g.verbose,duration:g.duration,queue:!0})):(p.debug("Showing results with javascript"),k.stop().fadeIn(g.duration,g.easing)),g.onResultsOpen.call(k))},hideResults:function(){p.is.visible()&&(p.can.transition()?(p.debug("Hiding results with css animations"),k.transition({animation:g.transition+" out",debug:g.debug,verbose:g.verbose,duration:g.duration,queue:!0})):(p.debug("Hiding results with javascript"),k.stop().fadeOut(g.duration,g.easing)),g.onResultsClose.call(k))},generateResults:function(t){p.debug("Generating html from response",t);var s=g.templates[g.type],r=e.isPlainObject(t.results)&&!e.isEmptyObject(t.results),n=e.isArray(t.results)&&t.results.length>0,i="";return r||n?(g.maxResults>0&&(r?"standard"==g.type&&p.error(y.maxResults):t.results=t.results.slice(0,g.maxResults)),e.isFunction(s)?i=s(t):p.error(y.noTemplate,!1)):i=p.displayMessage(y.noResults,"empty"),g.onResults.call(A,t),i},displayMessage:function(e,t){return t=t||"standard",p.debug("Displaying message",e,t),p.addResults(g.templates.message(e,t)),g.templates.message(e,t)},setting:function(t,s){if(e.isPlainObject(t))e.extend(!0,g,t);else{if(s===r)return g[t];g[t]=s}},internal:function(t,s){if(e.isPlainObject(t))e.extend(!0,p,t);else{if(s===r)return p[t];p[t]=s}},debug:function(){g.debug&&(g.performance?p.performance.log(arguments):(p.debug=Function.prototype.bind.call(console.info,console,g.name+":"),p.debug.apply(console,arguments)))},verbose:function(){g.verbose&&g.debug&&(g.performance?p.performance.log(arguments):(p.verbose=Function.prototype.bind.call(console.info,console,g.name+":"),p.verbose.apply(console,arguments)))},error:function(){p.error=Function.prototype.bind.call(console.error,console,g.name+":"),p.error.apply(console,arguments)},performance:{log:function(e){var t,s,r;g.performance&&(t=(new Date).getTime(),r=o||t,s=t-r,o=t,u.push({Name:e[0],Arguments:[].slice.call(e,1)||"",Element:A,"Execution Time":s})),clearTimeout(p.performance.timer),p.performance.timer=setTimeout(p.performance.display,500)},display:function(){var t=g.name+":",s=0;o=!1,clearTimeout(p.performance.timer),e.each(u,function(e,t){s+=t["Execution Time"]}),t+=" "+s+"ms",c&&(t+=" '"+c+"'"),a.length>1&&(t+=" ("+a.length+")"),(console.group!==r||console.table!==r)&&u.length>0&&(console.groupCollapsed(t),console.table?console.table(u):e.each(u,function(e,t){console.log(t.Name+": "+t["Execution Time"]+"ms")}),console.groupEnd()),u=[]}},invoke:function(t,s,n){var a,c,o,u=E;return s=s||f,n=A||n,"string"==typeof t&&u!==r&&(t=t.split(/[\. ]/),a=t.length-1,e.each(t,function(s,n){var i=s!=a?n+t[s+1].charAt(0).toUpperCase()+t[s+1].slice(1):t;if(e.isPlainObject(u[i])&&s!=a)u=u[i];else{if(u[i]!==r)return c=u[i],!1;if(!e.isPlainObject(u[n])||s==a)return u[n]!==r&&(c=u[n],!1);u=u[n]}})),e.isFunction(c)?o=c.apply(n,s):c!==r&&(o=c),e.isArray(i)?i.push(o):i!==r?i=[i,o]:o!==r&&(i=o),c}},d?(E===r&&p.initialize(),p.invoke(l)):(E!==r&&E.invoke("destroy"),p.initialize())}),i!==r?i:this},e.fn.search.settings={name:"Search",namespace:"search",debug:!1,verbose:!1,performance:!0,type:"standard",minCharacters:1,apiSettings:!1,source:!1,searchFields:["title","description"],searchFullText:!0,automatic:!0,hideDelay:0,searchDelay:200,maxResults:7,cache:!0,transition:"scale",duration:200,easing:"easeOutExpo",onSelect:!1,onResultsAdd:!1,onSearchQuery:function(){},onResults:function(e){},onResultsOpen:function(){},onResultsClose:function(){},className:{active:"active",empty:"empty",focus:"focus",loading:"loading",results:"results",pressed:"down"},error:{source:"Cannot search. No source used, and Semantic API module was not included",noResults:"Your search returned no results",logging:"Error in debug logging, exiting.",noEndpoint:"No search endpoint was specified",noTemplate:"A valid template name was not specified.",serverError:"There was an issue querying the server.",maxResults:"Results must be an array to use maxResults setting",method:"The method you called is not defined."},metadata:{cache:"cache",results:"results",result:"result"},regExp:{escape:/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,beginsWith:"(?:s|^)"},selector:{prompt:".prompt",searchButton:".search.button",results:".results",category:".category",result:".result",title:".title, .name"},templates:{escape:function(e){var t=/[&<>"'`]/g,s=/[&<>"'`]/,r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},n=function(e){return r[e]};return s.test(e)?e.replace(t,n):e},message:function(e,t){var s="";return e!==r&&t!==r&&(s+='<div class="message '+t+'">',s+="empty"==t?'<div class="header">No Results</div class="header"><div class="description">'+e+'</div class="description">':' <div class="description">'+e+"</div>",s+="</div>"),s},category:function(t){var s="",n=e.fn.search.settings.templates.escape;return t.results!==r&&(e.each(t.results,function(t,i){i.results!==r&&i.results.length>0&&(s+='<div class="category"><div class="name">'+i.name+"</div>",e.each(i.results,function(e,t){s+='<div class="result">',t.url&&(s+='<a href="'+t.url+'"></a>'),t.image!==r&&(t.image=n(t.image),s+='<div class="image"> <img src="'+t.image+'" alt=""></div>'),s+='<div class="content">',t.price!==r&&(t.price=n(t.price),s+='<div class="price">'+t.price+"</div>"),t.title!==r&&(t.title=n(t.title),s+='<div class="title">'+t.title+"</div>"),t.description!==r&&(s+='<div class="description">'+t.description+"</div>"),s+="</div></div>"}),s+="</div>")}),t.action&&(s+='<a href="'+t.action.url+'" class="action">'+t.action.text+"</a>"),s)},standard:function(t){var s="";return t.results!==r&&(e.each(t.results,function(e,t){s+=t.url?'<a class="result" href="'+t.url+'">':'<a class="result">',t.image!==r&&(s+='<div class="image"> <img src="'+t.image+'"></div>'),s+='<div class="content">',t.price!==r&&(s+='<div class="price">'+t.price+"</div>"),t.title!==r&&(s+='<div class="title">'+t.title+"</div>"),t.description!==r&&(s+='<div class="description">'+t.description+"</div>"),s+="</div>",s+="</a>"}),t.action&&(s+='<a href="'+t.action.url+'" class="action">'+t.action.text+"</a>"),s)}}}}(jQuery,window,document);